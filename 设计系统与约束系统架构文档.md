# AINO-app 设计系统与约束系统架构文档

## 📋 概述

本文档详细描述了 AINO-app 的完整设计系统架构，包括设计令牌系统、组件系统、卡片拖拽系统、约束系统等核心架构。整个系统遵循"卡片是内容承载，组件专注于功能，主次关系明确"的设计哲学。

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    AINO-app 设计系统架构                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        设计令牌层 (Design Tokens)                │
├─────────────────────────────────────────────────────────────────┤
│  Foundation Layer    │  Semantic Layer    │  Component Layer    │
│  - 颜色调色板        │  - 语义令牌        │  - 组件变体         │
│  - 字体系统          │  - 上下文映射      │  - 尺寸配置         │
│  - 间距系统          │  - 回退链          │  - 状态样式         │
│  - 圆角系统          │  - 主题适配        │  - 交互效果         │
└─────────────────────┴───────────────────┴─────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        约束系统层 (Constraints)                  │
├─────────────────────────────────────────────────────────────────┤
│  UnifiedDesignConstraints  │  CardLayoutConstraints  │  ConfigValidator │
│  - 组件验证               │  - 拖拽约束             │  - 配置策略       │
│  - 设计规范检查           │  - 布局验证             │  - 策略引擎       │
│  - 违规检测               │  - 尺寸约束             │  - 回退链         │
└─────────────────────┴───────────────────┴─────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        组件系统层 (Components)                   │
├─────────────────────────────────────────────────────────────────┤
│  UI Components        │  Business Components  │  Layout Components │
│  - Button             │  - CourseCard         │  - AppCard         │
│  - Input              │  - JobCard            │  - DraggableCard   │
│  - Card               │  - ProductCard        │  - DynamicPage     │
│  - Navigation         │  - UserCard           │  - GridLayout      │
└─────────────────────┴───────────────────┴─────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        拖拽系统层 (Drag & Drop)                  │
├─────────────────────────────────────────────────────────────────┤
│  @dnd-kit Core        │  Sortable System     │  Grid System       │
│  - DndContext         │  - SortableContext   │  - GridLayout      │
│  - useDraggable       │  - useSortable       │  - ResizeHandle    │
│  - useDroppable       │  - arrayMove         │  - GridConstraints │
└─────────────────────┴───────────────────┴─────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        主题系统层 (Theme System)                 │
├─────────────────────────────────────────────────────────────────┤
│  Theme Providers      │  Theme Configs       │  Theme Presets     │
│  - UnifiedProvider    │  - DesignTokens      │  - Light Theme     │
│  - CardThemeProvider  │  - ComponentConfig   │  - Dark Theme      │
│  - LocalThemeProvider │  - LayoutConfig      │  - Custom Themes   │
└─────────────────────┴───────────────────┴─────────────────────┘
```

## 🎨 设计令牌系统 (Design Tokens)

### 1. 分层架构

#### Foundation Layer (基础层)
```typescript
// 颜色调色板
const colorPalette = {
  primary: { 50: "#eff6ff", 100: "#dbeafe", ..., 900: "#1e3a8a" },
  secondary: { 50: "#f8fafc", 100: "#f1f5f9", ..., 900: "#0f172a" },
  neutral: { 50: "#fafafa", 100: "#f5f5f5", ..., 900: "#171717" }
}

// 字体系统
const typography = {
  fontFamily: { primary: "system-ui", secondary: "Georgia", mono: "ui-monospace" },
  fontSize: { xs: "0.75rem", sm: "0.875rem", ..., "3xl": "1.875rem" },
  fontWeight: { light: 300, normal: 400, ..., bold: 700 }
}

// 间距系统
const spacing = { xs: "0.25rem", sm: "0.5rem", ..., "3xl": "4rem" }

// 圆角系统
const radius = { none: "0", sm: "0.125rem", ..., full: "9999px" }
```

#### Semantic Layer (语义层)
```typescript
// 语义令牌映射
const semanticTokens = {
  'surface.default': {
    background: 'hsl(var(--background))',
    color: 'hsl(var(--foreground))',
    border: 'hsl(var(--border))',
    fallback: ['hsl(var(--neutral-50))', 'hsl(var(--neutral-100))']
  },
  'text.primary': {
    color: 'hsl(var(--foreground))',
    fallback: ['hsl(var(--neutral-900))', 'hsl(var(--neutral-800))']
  }
}
```

#### Component Layer (组件层)
```typescript
// 组件变体配置
const componentVariants = {
  button: {
    variants: { default: "bg-primary", outline: "border border-input", ... },
    sizes: { sm: "h-9", default: "h-10", lg: "h-11" }
  }
}
```

### 2. CSS 变量系统

```css
:root {
  /* 主色调 - 基于设计令牌 */
  --primary-50: 213 100% 96%;
  --primary-500: 217 91% 60%;
  --primary-900: 222 84% 5%;
  
  /* 功能颜色 */
  --primary: 217 91% 60%;
  --primary-foreground: 0 0% 100%;
  --background: 0 0% 100%;
  --foreground: 222 47% 11%;
  
  /* 圆角系统 */
  --radius-sm: 0.125rem;
  --radius-md: 0.375rem;
  --radius-lg: 0.5rem;
}
```

## 🧩 组件系统架构

### 1. 组件分层

#### UI Components (基础UI组件)
```typescript
// 位置: components/ui/
- button.tsx          // 统一按钮组件
- input.tsx           // 统一输入框组件
- card.tsx            // 统一卡片组件
- avatar.tsx          // 头像组件
- badge.tsx           // 徽章组件
```

#### Business Components (业务组件)
```typescript
// 位置: components/card/business-cards/
- course-card.tsx     // 课程卡片
- job-card.tsx        // 职位卡片
- product-card.tsx    // 产品卡片
- user-card.tsx       // 用户卡片
```

#### Layout Components (布局组件)
```typescript
// 位置: components/layout/
- app-card.tsx        // 应用卡片容器
- draggable-card.tsx  // 可拖拽卡片
- dynamic-page.tsx    // 动态页面组件
```

### 2. 组件工厂模式

```typescript
// 卡片工厂
export function CardFactory({
  id,
  type,
  cardName,
  data,
  onAction,
  children,
  disableConstraints = false
}: CardFactoryProps) {
  // 1. 验证卡片类型
  const cardDefinition = CardRegistry.getCardDefinition(type)
  
  // 2. 应用约束检查
  if (!disableConstraints) {
    const validation = validateCardLayout(type, { id, data })
    if (!validation.isValid) {
      console.warn("卡片约束验证失败:", validation.violations)
    }
  }
  
  // 3. 创建卡片实例
  return (
    <AppCard id={id} localThemeKey={id}>
      {cardDefinition.component({ data, onAction, ...cardDefinition.props })}
    </AppCard>
  )
}
```

## 🃏 卡片拖拽系统架构

### 1. 拖拽系统核心

#### @dnd-kit 集成
```typescript
// 拖拽上下文
<DndContext
  sensors={sensors}
  collisionDetection={closestCenter}
  onDragStart={handleDragStart}
  onDragEnd={handleDragEnd}
>
  <SortableContext items={items} strategy={rectSortingStrategy}>
    {items.map(item => (
      <DraggableCard key={item.id} id={item.id}>
        {item.component}
      </DraggableCard>
    ))}
  </SortableContext>
</DndContext>
```

#### 拖拽卡片组件
```typescript
export function DraggableCard({
  id,
  children,
  className,
  isEditing = false,
  layout,
  onResize,
  onScale,
  gridSize = 120,
  layoutMode = "grid"
}: DraggableCardProps) {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id,
    disabled: !isEditing || isResizing,
  })

  // 架构原则验证
  useEffect(() => {
    const validation = validateCardLayout("DraggableCard", { id, children, layout })
    if (!validation.isValid) {
      console.warn("DraggableCard 架构验证:", validation.violations)
    }
  }, [id, children, layout])

  return (
    <AppCard
      ref={setNodeRef}
      className={cn(
        isDragging && "opacity-50 scale-105 z-50",
        className
      )}
      {...dragHandleProps}
    >
      {children}
    </AppCard>
  )
}
```

### 2. 布局模式

#### 网格布局 (Grid Layout)
```typescript
const gridLayout = {
  mode: "grid",
  gridSize: 120,
  constraints: {
    minWidth: 2,
    minHeight: 2,
    maxWidth: 12,
    maxHeight: 8
  }
}
```

#### 自由布局 (Freeform Layout)
```typescript
const freeformLayout = {
  mode: "freeform",
  constraints: {
    minWidth: 260,
    minHeight: 180,
    snapToGrid: true
  }
}
```

### 3. 拖拽约束系统

```typescript
export class CardLayoutConstraints {
  validateDragOperation(
    cardId: string, 
    newPosition: { x: number; y: number },
    newSize: { w: number; h: number }
  ): ValidationResult {
    const violations: string[] = []
    
    // 1. 边界检查
    if (newPosition.x < 0 || newPosition.y < 0) {
      violations.push("卡片位置不能超出容器边界")
    }
    
    // 2. 尺寸约束
    if (newSize.w < this.minWidth || newSize.h < this.minHeight) {
      violations.push(`卡片尺寸不能小于 ${this.minWidth}x${this.minHeight}`)
    }
    
    // 3. 重叠检查
    if (this.hasOverlap(cardId, newPosition, newSize)) {
      violations.push("卡片不能与其他卡片重叠")
    }
    
    return {
      isValid: violations.length === 0,
      violations,
      recommendations: this.generateRecommendations(violations)
    }
  }
}
```

## 🔒 约束系统架构

### 1. 统一设计约束

```typescript
export class UnifiedDesignConstraints {
  validateComponent(componentName: string, props: any): ValidationResult {
    const violations: string[] = []
    const recommendations: string[] = []

    // 1. 颜色使用约束
    this.validateColorUsage(componentName, props, violations, recommendations)
    
    // 2. 字体使用约束
    this.validateFontUsage(componentName, props, violations, recommendations)
    
    // 3. 卡片主题约束
    this.validateCardTheme(componentName, props, violations, recommendations)
    
    // 4. 布局约束
    this.validateLayout(componentName, props, violations, recommendations)

    return { isValid: violations.length === 0, violations, recommendations }
  }
}
```

### 2. 配置验证系统

```typescript
// 配置策略
const defaultPolicies: ConfigPolicy[] = [
  {
    name: 'semantic-token-validation',
    description: '验证语义令牌的有效性',
    rules: [
      '所有语义令牌必须存在于语义令牌映射中',
      '语义令牌必须具有有效的回退链',
      '禁止直接使用Foundation层的颜色值'
    ],
    severity: 'error'
  },
  {
    name: 'contrast-ratio-compliance',
    description: '确保对比度符合WCAG标准',
    rules: [
      '文本对比度必须满足WCAG AA标准（4.5:1）',
      '大文本对比度必须满足WCAG AA标准（3:1）'
    ],
    severity: 'error'
  }
]
```

### 3. 架构原则验证

```typescript
// 卡片布局约束
export function validateCardLayout(
  componentName: string, 
  props: any
): ValidationResult {
  const violations: string[] = []
  const recommendations: string[] = []

  // 1. 卡片是内容承载原则
  if (!props.children && !props.data) {
    violations.push("卡片必须包含内容或数据")
    recommendations.push("使用 children 或 data 属性提供卡片内容")
  }

  // 2. 组件专注于功能原则
  if (props.className && props.className.includes('bg-')) {
    violations.push("组件不应直接定义背景色")
    recommendations.push("使用 AppCard 容器或主题系统定义样式")
  }

  // 3. 主次关系明确原则
  if (props.isDraggable && !props.layout) {
    violations.push("可拖拽卡片必须定义布局信息")
    recommendations.push("提供 layout 属性定义卡片位置和尺寸")
  }

  return { isValid: violations.length === 0, violations, recommendations }
}
```

## 🎭 主题系统架构

### 1. 主题提供者链

```typescript
// 主题提供者层次结构
<UnifiedProvider>
  <CardThemeProvider>
    <LocalThemeProvider>
      <Component />
    </LocalThemeProvider>
  </CardThemeProvider>
</UnifiedProvider>
```

### 2. 主题配置系统

```typescript
// 统一主题配置
export const useUnifiedConfig = () => {
  const [designTokens, setDesignTokens] = useState(defaultDesignTokens)
  const [componentConfig, setComponentConfig] = useState(defaultComponentConfig)
  const [cardTheme, setCardTheme] = useState(defaultCardTheme)
  
  return {
    designTokens: { value: designTokens, set: setDesignTokens },
    componentConfig: { value: componentConfig, set: setComponentConfig },
    cardTheme: { value: cardTheme, set: setCardTheme }
  }
}
```

### 3. 主题预设系统

```typescript
// 主题预设
export const themePresets = {
  light: {
    colors: { primary: "#3b82f6", background: "#ffffff" },
    shadows: { sm: "0 1px 2px", md: "0 4px 6px" }
  },
  dark: {
    colors: { primary: "#60a5fa", background: "#0f172a" },
    shadows: { sm: "0 1px 2px", md: "0 4px 6px" }
  },
  minimal: {
    colors: { primary: "#737373", background: "#fafafa" },
    shadows: { sm: "none", md: "none" }
  }
}
```

## 🔧 开发约束与规范

### 1. 组件开发规范

#### 必须遵循的原则
1. **卡片是内容承载**: 所有内容必须通过 AppCard 容器承载
2. **组件专注于功能**: 组件只处理自己的核心功能，不处理样式
3. **主次关系明确**: 调用方控制整体结构，组件提供功能

#### 禁止的做法
```typescript
// ❌ 错误：组件直接定义样式
<button className="bg-blue-500 text-white px-4 py-2 rounded-lg">
  按钮
</button>

// ✅ 正确：使用统一组件
<Button variant="default" size="lg">
  按钮
</Button>
```

### 2. 卡片开发规范

#### 卡片结构
```typescript
// ✅ 正确的卡片结构
<AppCard id={id} localThemeKey={id}>
  <CardHeader>
    <CardTitle>{title}</CardTitle>
  </CardHeader>
  <CardContent>
    {content}
  </CardContent>
  <CardFooter>
    <Button onClick={onAction}>操作</Button>
  </CardFooter>
</AppCard>
```

#### 拖拽集成
```typescript
// ✅ 正确的拖拽集成
<DraggableCard id={id} layout={layout} onResize={onResize}>
  <BusinessCard data={data} onAction={onAction} />
</DraggableCard>
```

### 3. 约束检查集成

```typescript
// 开发时自动约束检查
useEffect(() => {
  const validation = UnifiedDesignConstraints.getInstance()
    .validateComponent(componentName, props)
  
  if (!validation.isValid) {
    console.warn(`组件 ${componentName} 违反设计约束:`, validation.violations)
    console.log("建议:", validation.recommendations)
  }
}, [componentName, props])
```

## 📊 系统监控与优化

### 1. 性能监控

```typescript
// 拖拽性能监控
const performanceMonitor = {
  trackDragOperation: (startTime: number, endTime: number) => {
    const duration = endTime - startTime
    if (duration > 16) { // 超过一帧时间
      console.warn(`拖拽操作耗时 ${duration}ms，可能影响性能`)
    }
  }
}
```

### 2. 约束违规监控

```typescript
// 约束违规统计
const constraintMonitor = {
  violations: new Map<string, number>(),
  
  recordViolation: (componentName: string, violation: string) => {
    const key = `${componentName}:${violation}`
    this.violations.set(key, (this.violations.get(key) || 0) + 1)
  },
  
  getReport: () => {
    return Array.from(this.violations.entries())
      .sort(([,a], [,b]) => b - a)
      .slice(0, 10) // 前10个最频繁的违规
  }
}
```

## 🚀 未来扩展计划

### 1. 高级拖拽功能
- 多选拖拽
- 嵌套拖拽
- 拖拽预览
- 拖拽撤销/重做

### 2. 智能约束系统
- AI驱动的约束建议
- 自动布局优化
- 响应式约束适配

### 3. 可视化设计工具
- 拖拽式主题编辑器
- 实时约束检查面板
- 组件库可视化管理

## 📝 总结

AINO-app 的设计系统与约束系统架构具有以下特点：

### 🏆 核心优势

1. **分层清晰**: Foundation → Semantic → Component 三层设计令牌
2. **约束严格**: 多层级约束系统确保设计一致性
3. **拖拽强大**: 基于 @dnd-kit 的完整拖拽解决方案
4. **主题灵活**: 多层级主题管理，支持实时切换
5. **架构原则**: 明确的"卡片是内容承载"设计哲学

### 🎯 技术特色

1. **类型安全**: 完整的 TypeScript 类型定义
2. **性能优化**: 拖拽操作性能监控和优化
3. **可扩展性**: 工厂模式和注册机制支持动态扩展
4. **可维护性**: 清晰的代码结构和文档

这个架构为构建复杂的拖拽式应用和设计系统提供了坚实的基础，特别适合需要高度定制化和一致性的企业级应用。
